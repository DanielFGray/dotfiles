#!/usr/bin/env bash

has() {
	if type "$1" &> /dev/null; then
		return 0
	else
		[[ ! "$2" == '-s' ]] && echo >&2 "$1 not found"
		return 1
	fi
}

if ! has 'byzanz-record'; then
	echo 'requires byzanz-record'
	exit 1
fi

help() {
	echo 'Usage:
  -f [file name]
  -w select particular window
  -d duration
  -D delay
  -h this help
  -s draw selectable region
  -- pass additional options to byzanz-record (ie -c for cursor)'
	exit
}

file="$HOME/images/screenshots/$(date '+%F-%s').gif"
window=false
region=false
duration='10'
delay=0

OPTERR=0
while getopts "hf:wd:D:s" opt; do
	case "$opt" in
		f) file=$OPTARG ;;
		w) window=true;region=false  ;;
		s) window=false;region=true  ;;
		d) duration=$OPTARG  ;;
		D) delay=$OPTARG  ;;
		h) help  ;;
		'?') echo >&2 RUH ROH; exit 1;;
	esac
done
shift $((OPTIND-1))

delay() {
	for (( i=delay; i>0; --i )) ; do
		echo -ne "$i..\r"
		sleep 1
	done
	echo 'recording'
}

if [[ "$window" == true ]]; then
	echo -ne 'click a window\r'
	xwininfo=$(xwininfo)
	read x < <(awk -F':' '/Absolute upper-left X/{print $2}' <<< "$xwininfo")
	read y < <(awk -F':' '/Absolute upper-left Y/{print $2}' <<< "$xwininfo")
	read w < <(awk -F':' '/Width/{print $2}' <<< "$xwininfo")
	read h < <(awk -F':' '/Height/{print $2}' <<< "$xwininfo")
	printf -v args '%s %s %s %s' "--x=$x" "--y=$y" "--width=$w" "--height=$h"
elif [[ "$region" == true ]]; then
	if has 'xrectsel'; then
		echo -ne 'select a region\r'
		args=$(xrectsel '--x=%x --y=%y --width=%w --height=%h')
	else
		echo >&2 'xrectsel required for -s'
		echo >&2 '  https://github.com/lolilolicon/FFcast2/blob/master/xrectsel.c'
	fi
fi

echo "saving to $file"
delay
byzanz-record --duration="$duration" "$args" "$@" "$file"

#TODO: changeable image viewer
if [[ -f "$file" ]] && has -s 'mirage';then
	mirage "$file" &> /dev/null
fi

if [[ -f "$file" ]] && has -s 'pomf'; then
	printf 'upload to pomf? '
	read upload
	case "$upload" in
		[Yy]* )
			pomf "${file}"
			break ;;
		*) break ;;
	esac
fi
