#!/usr/bin/env bash

if [[ -e ${HOME}/.bash_utils ]]; then
  source ${HOME}/.bash_utils
else
  echo -e "\e[31mbash_utils not found\e[0m" >&2
  exit 1
fi

usage() {
  more <<'HELP'
fv [OPTIONS] [SEARCH]
fuzzy file filtering and command executing

-c    command to execute [defaults to vim]
-a    search all dirs and hidden files (still quirky)
HELP
}

setCmd() {
   if has $1; then
    cmd="$1"
  else
    die "$1 is not a valid command"
  fi
}

if ! has 'fzf'; then
  die 'requires fzf installed'
fi

cmd='vim'
cmdopts=()
searchstr=''
searchcmd=''
searchopts=()
allfiles=false

while getopts "hac:" opt; do
  case "$opt" in
    h) usage; exit 0    ;;
    a) allfiles=true     ;;
    c) setCmd "$OPTARG" ;;
  esac
done
shift "$((OPTIND-1))"

if [[ "$cmd" == 'vim' ]]; then
  if [[ -n "$DISPLAY" ]] && has v; then
    cmd='v'
  elif has 'nvim'; then
    cmd='nvim'
  fi
fi

# for c in 'ag' 'ack' 'grep'; do
for c in 'grep'; do
  if has "$c"; then
    searchcmd="$c"
    break
  fi
done

# if [[ $searchcmd  == 'grep' ]]; then
#   err 'you should strongly consider installing ag or ack'
#   sleep .5
# fi

if [[ -n "$1" ]]; then
  if [[ -d "$1" ]]; then
    searchopts+=( "$1" )
  else
    searchstr="$1"
  fi
  shift
fi

case "$searchcmd" in
  'ag')
    searchopts+=( '--color' )
    if [[ "$allfiles" == true ]]; then
      searchopts+=( '-a' '--hidden' )
    # else
    #   searchopts+=( '-t' )
    fi
    if [[ "$searchstr" == '' ]]; then
      searchopts+=( '-g' '' )
    fi
    ;;
  'ack')
    if [[ "$searchstr" == '' ]]; then
      if [[ "$allfiles" == false ]]; then
        searchopts+=( '-g' '^[^\.]' )
      else
        searchopts+=( '-f' )
      fi
    else
      searchopts+=( '-l' )
    #   searchopts+=( '--match' )
    fi
    ;;
  'grep')
    searchopts+=( '-l' '-r' '-I' )
    if [[ "$allfiles" == false ]]; then
      searchopts+=( '--exclude-dir=bower_components' )
      searchopts+=( '--exclude-dir=node_modules' )
      searchopts+=( '--exclude-dir=jspm_packages' )
      searchopts+=( '--exclude-dir=.cvs' )
      searchopts+=( '--exclude-dir=.git' )
      searchopts+=( '--exclude-dir=.hg' )
      searchopts+=( '--exclude-dir=.svn' )
    fi
    if [[ "$searchstr" == '' ]]; then
      searchopts+=( '' )
    fi
    ;;
esac

if [[ "$searchstr" != '' ]]; then
  searchopts+=( "$searchstr" )
fi

# err "$searchcmd ${searchopts[*]}" # verbose option?
mapfile -t files < <(command "$searchcmd" "${searchopts[@]}" 2> /dev/null | fzf -e -m --reverse --ansi)

if [[ ${#files[@]} == 0 ]]; then
  # err 'no files selected, exiting' # verbose option?
  exit 0
fi

# err "$cmd ${cmdopts[@]} ${files[*]}" # verbose option?
exec $cmd "${cmdopts[@]}" "${files[@]}"
