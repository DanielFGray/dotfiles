#!/usr/bin/env bash

usage() {
	cat <<'HELP'
-s    string to search
-t    list only text files
-c    command to execute [defaults to vim]
HELP
}

has() {
	command -v "$1" &> /dev/null
}

err() {
	echo -e "\e[31m$1\e[0m" >&2
}

setCmd() {
	 if has $1; then
		cmd="$1"
	else
		err "$1 is not a valid command"
		exit 1
	fi
}

if ! has 'ag' || ! has 'fzf'; then
	err 'requires fzf and ag installed'
	exit 1
fi

cmd='vim'
textOnly=false
search=''
cmdopts=()
agopts=( '-t' )

while getopts "hs:c:" opt; do
	case "$opt" in
		h) usage; exit 0         ;;
		c) setCmd "$OPTARG"      ;;
		a) agopts+=( "$OPTARG" ) ;;
	esac
done
shift "$((OPTIND-1))"

if [[ -n "$1" ]]; then
	search="$1";
	shift
fi

if [[ "$search" != '' ]]; then
	# agopts+=( '-g ""' )
	agopts+=( "'$search'" )
	if [[ "$cmd" == 'vim' ]]; then
		cmdopts+=( " +'/$search'" )
	fi
fi

# err "ag -l ${agopts[@]}"
mapfile -t files < <(eval "ag -l ${agopts[@]}" | fzf -e -m --reverse +s)

if [[ ${#files[@]} == 0 ]]; then
	exit 0
fi

exec $cmd "${cmdopts[@]}" "${files[@]}"
