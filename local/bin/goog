#!/usr/bin/env bash

if [[ -e $HOME/.bash_utils ]]; then
  source $HOME/.bash_utils
else
  echo -e "\e[31mbash_utils not found\e[0m" >&2
  exit 1
fi

# http://stackoverflow.com/a/10660730
rawurlencode() {
  local string="$*"
  local strlen=${#string}
  local encoded=""

  for (( pos=0; pos < strlen; pos++ )); do
     c="${string:$pos:1}"
     case "$c" in
        [-_.~a-zA-Z0-9])
          o="$c" ;;
        *)
          printf -v o '%%%02x' "'$c"
     esac
     encoded+="${o}"
  done
  echo "${encoded}"
}

has -v curl jq fzf || die

# declare -a opts
# while true; do
#   case $1 in
#     -*) opts+="$1"
#   esac
# done

command curl -sfL "http://ajax.googleapis.com/ajax/services/search/web?v=1.0&rsz=5&q=$(rawurlencode "$*")" |
  jq -c '.["responseData"]["results"] | map("\(.unescapedUrl) | \(.title) | \(.content)") | .[]' |
  sed -r 's/<[^>]*>//g; s/\\n//g; s/^\s*"//; s/",?$//' |
  fzf -e --ansi --cycle --inline-info | awk '{print $1}' | xargs -I% w3m %
