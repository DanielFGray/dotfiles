#!/usr/bin/env bash

if [[ -e ${HOME}/.bash_utils ]]; then
  source ${HOME}/.bash_utils
else
  echo -e "\e[31mbash_utils not found\e[0m" >&2
  exit 1
fi

declare installer
declare search

has -v fzf || die

fzf() {
  command fzf -e +s --multi --cycle --ansi --no-hscroll "$@"
}

if [[ -f /etc/debian_version ]]; then
  mapfile -t pkgs < <(
    apt-cache search '' |
    sed -u -r "s|^([^ ]+)|${c_green}\1${c_reset}|" |
    fzf --query="$*" |
    awk '{print $1}'
  )
  (( ${#pkgs} > 0 )) || exit
  sudo $(getCommandFallbacks 'apt' 'apt-get') install "${pkgs[@]}"
elif [[ -f /etc/arch-release ]]; then
  if (( $# > 0)); then
    search=$(getCommandFallbacks 'pacaur' 'yaourt' 'packer' 'apacman' 'pacman')
  else
    search='pacman'
  fi
  mapfile -t pkgs < <(
    $search -Ss "$@" |
    sed -u -r -n "/^[^ ]/{s/$/ -/; x; s|^([^/]+)/([^ ]+)|[${c_blue}\1${c_reset}] ${c_green}\2${c_reset}|; p;}; /^ /{s/^ */ /; x; G; s/\n//; x}" |
    fzf --header-lines=1 |
    awk '{print $2}'
  )
  (( ${#pkgs} > 0 )) || exit
  ${search/pacman/sudo pacman} -S "${pkgs[@]}"
fi
