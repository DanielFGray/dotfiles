#!/usr/bin/env bash

declare installer
declare search

has() {
  command -v $1 &> /dev/null
}

fzf() {
  $(which fzf) -e --tac --multi --cycle --ansi "$@"
}

esc=$(printf '\033')
tput_reset="${esc}[0m"
tput_red="${esc}[31m"
tput_green="${esc}[32m"
tput_blue="${esc}[34m"

if [[ -f /etc/debian_version ]]; then
  for installer in 'apt' 'apt-get'; do
    if has $installer; then
      mapfile -t pkgs < <(
        apt-cache search '' |
        sed -r "s|^([^ ]+)|${tput_green}\1${tput_reset}|" |
        fzf --query="$*" |
        awk '{print $1}'
      )
      (( ${#pkgs} > 0 )) || exit
      sudo $installer install "${pkgs[@]}"
      break
    fi
  done
elif [[ -f /etc/arch-release ]]; then
  for installer in 'pacaur' 'yaourt' 'packer' 'pacman'; do
    if has "$installer"; then
      search="$installer"
      (( $# < 1)) && search='pacman'
      mapfile -t pkgs < <(
        $search -Ss "$@" |
        sed -rn "/^[^ ]/{s/$/ -/; x; s|^([^/]+)/([^ ]+)|[${tput_blue}\1${tput_reset}] ${tput_green}\2${tput_reset}|; p;}; /^ /{s/^ */ /; x; G; s/\n//; x}" |
        fzf --header-lines=1 |
        awk '{print $2}'
      )
      (( ${#pkgs} > 0 )) || exit
      ${installer/pacman/sudo pacman} -S "${pkgs[@]}"
      break
    fi
  done
fi
