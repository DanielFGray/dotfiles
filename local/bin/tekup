#!/usr/bin/env bash

declare verbose=0
declare esc=$'\033'
declare c_reset="${esc}[0m"
declare c_red="${esc}[31m"
declare c_blue="${esc}[34m"
declare processes=1

info() {
  printf "${c_blue}%s${c_reset}\n" "$1" >&2
}
export -f info

err() {
  printf "${c_red}%s${c_reset}\n" "$1" >&2
}
export -f err

die() {
  [[ -n "$1" ]] && err "$1"
  exit 1
}
export -f err

usage() {
  less -EXR <<-'HELP'
Usage: tekup [OPTIONS] [FILES..]
  -h          print this help
  -p [NUMBER] use [NUMBER] of concurrent processes to upload files with.
              defaults to 1
  -v          print verbose output. there are two levels of verbosity
              (because this thing is over-engineered), the first will print
              the JSON response from teknik, the second will also pass the
              -v option to curl
HELP
}

upload() {
  local file mime url post curl_verbosity
  file="$1"

  if [[ ! -e "$file" ]]; then
    err "$file does not exist"
    return 1
  fi

  mime=$(file -ib "$file")
  mime="${mime%%/*}"

  if (( verbose < 1 )); then
    curl_verbosity='-s'
  elif (( verbose == 1)); then
    curl_verbosity=''
  else
    curl_verbosity='-v'
  fi

  if [[ $mime == 'text' ]]; then
    post=$(command curl ${curl_verbosity} --data "title=${file##*/}" --data-urlencode "code=$(< "${file}")" https://api.teknik.io/v1/Paste)
  else
    post=$(command curl ${curl_verbosity} -F "contentType=${mime}" -F "file=@${file}" https://api.teknik.io/v1/Upload)
  fi

  (( verbose > 0 )) && info "response: ${c_reset}${post}"

  [[ -z "$post" || "$post" != *'http'* || "$post" == *'error'* ]] && die "error uploading ${file}"

  url=$(grep -oP 'https://[[:alnum:]?=%/_.:,;~@!#$&()*+-]+' <<< "$post")
  printf '%s: %s\n' "$file" "$url"
}
export -f upload

command -v curl &> /dev/null || die 'curl not found'

OPTERR=0
while getopts "hvp:" opt; do
  case "$opt" in
    h) usage; exit 0 ;;
    v) (( verbose++ )) ;;
    p) processes="$OPTARG" ;;
  esac
done
shift "$((OPTIND-1))"

(( $# > 0 )) || die 'No files to upload.'

printf '%s\n' "$@" | xargs -P"$processes" -I% bash -c 'upload %'
